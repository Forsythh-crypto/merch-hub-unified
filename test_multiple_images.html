<!DOCTYPE html>
<html>
<head>
    <title>Test Multiple Images</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .listing { border: 1px solid #ccc; margin: 10px; padding: 15px; }
        .images { display: flex; gap: 10px; margin: 10px 0; }
        .image { width: 100px; height: 100px; object-fit: cover; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Test Multiple Images API</h1>
    <div id="results"></div>
    
    <script>
        async function testAPI() {
            const resultsDiv = document.getElementById('results');
            
            try {
                // Test with Department Admin token
                const tokenResponse = await fetch('http://localhost:8000/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'admin@example.com',
                        password: 'password'
                    })
                });
                
                const tokenData = await tokenResponse.json();
                console.log('Login response:', tokenData);
                
                if (!tokenData.token) {
                    resultsDiv.innerHTML = '<div class="error">Login failed</div>';
                    return;
                }
                
                // Create a new listing with multiple images
                const formData = new FormData();
                formData.append('title', 'Test Listing with Multiple Images');
                formData.append('description', 'This is a test listing with 3 images');
                formData.append('price', '99.99');
                formData.append('category_id', '1');
                formData.append('stock_quantity', '10');
                
                // Create dummy image files (1x1 pixel images)
                const createDummyImage = (name, color) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 100;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = color;
                    ctx.fillRect(0, 0, 100, 100);
                    return new Promise(resolve => {
                        canvas.toBlob(resolve, 'image/png');
                    });
                };
                
                const image1 = await createDummyImage('image1', 'red');
                const image2 = await createDummyImage('image2', 'blue');
                const image3 = await createDummyImage('image3', 'green');
                
                formData.append('image', image1, 'image1.png');
                formData.append('image_1', image2, 'image2.png');
                formData.append('image_2', image3, 'image3.png');

                const listingResponse = await fetch('http://localhost:8000/api/listings', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${tokenData.token}`
                    },
                    body: formData
                });
                
                const listingData = await listingResponse.json();
                console.log('Listing creation response:', listingData);
                
                // Get user listings
                const listingsResponse = await fetch('http://localhost:8000/api/user/listings', {
                    headers: {
                        'Authorization': `Bearer ${tokenData.token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const listingsData = await listingsResponse.json();
                console.log('Listings response:', listingsData);
                
                let html = '<div class="success">API Test Results (Created new listing with images):</div>';
                
                if (listingsData.listings && listingsData.listings.length > 0) {
                    listingsData.listings.forEach(listing => {
                        html += `
                            <div class="listing">
                                <h3>${listing.title}</h3>
                                <p>Images count: ${listing.images ? listing.images.length : 0}</p>
                                <div class="images">`;
                        
                        if (listing.images && listing.images.length > 0) {
                            listing.images.forEach(image => {
                                const imageUrl = `http://localhost:8000/storage/${image.image_path}`;
                                html += `<img src="${imageUrl}" class="image" alt="Listing image" onerror="this.style.border='2px solid red'">`;
                            });
                        } else {
                            html += '<p>No images found</p>';
                        }
                        
                        html += '</div></div>';
                    });
                } else {
                    html += '<div class="error">No listings found</div>';
                }
                
                resultsDiv.innerHTML = html;
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Run test when page loads
        testAPI();
    </script>
</body>
</html>